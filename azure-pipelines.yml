name: Update OWASP dependency checks
pool:
  vmImage: 'Ubuntu 16.04'
variables:
  serviceConnection: azurerm-prod
  keyvaultName: infra-vault
steps:
  - task: AzureKeyVault@1
    displayName: 'Get secrets from Keyvault'
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      keyVaultName: ${{ parameters.keyvaultName }}
      secretsFilter: 'OWASPDb-Password,OWASPDb-Account'

  - task: Gradle@2
    inputs:
      gradleWrapperFile: 'gradlew'
      options: "-DdependencyCheck.failBuild=true -DdependencyCheck.cveValidForHours=24 -Danalyzer.central.enabled=false -DdependencyCheck.data.driver='com.microsoft.sqlserver.jdbc.SQLServerDriver' -DdependencyCheck.data.connectionString='jdbc:sqlserver://owaspdependencycheck.database.windows.net:1433;database=owaspdependencycheck;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;' -DdependencyCheck.data.username='${{OWASPDb-Account}}' -DdependencyCheck.data.password='${{OWASPDb-Password}}'"
      tasks: 'dependencyCheckUpdate'